CREATE EXTERNAL TABLE service_calls(uniqueKey int, createdDate string, closedDate string, agency string, complainType string, zipCode int, address string, landmark string, status string, latitude decimal, longitude decimal, location string)
COMMENT '311 service requests from brooklyn 2019-2021'
ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS TEXTFILE
LOCATION '/user/ah4672/service_calls.tsv';

CREATE TABLE issues_by_zipcode AS
SELECT zipcode,  Sum(CASE WHEN complaintype = 'Noise - Residential' THEN 1 ELSE 0 END) AS Noise_Residential, Sum(CASE WHEN complaintype = 'Illegal Parking' THEN 1 ELSE 0 END) AS Illegal_Parking, Sum(CASE WHEN complaintype = 'HEAT/HOT WATER' THEN 1 ELSE 0 END) AS Heat_hotwater, Sum(CASE WHEN complaintype = 'Blocked Driveway' THEN 1 ELSE 0 END) AS Blocked_driveway, Sum(CASE WHEN complaintype = 'Noise - Street/Sidewalk' THEN 1 ELSE 0 END) AS Noise_Street_Sidewalk, Sum(CASE WHEN complaintype = 'UNSANITARY CONDITION' THEN 1 ELSE 0 END) AS Unsanitary_condition, Sum(CASE WHEN complaintype = 'Street Condition' THEN 1 ELSE 0 END) AS Street_condition, Sum(CASE WHEN complaintype = 'Water System' THEN 1 ELSE 0 END) AS Water_system, Sum(CASE WHEN complaintype = 'General Construction/Plumbing' THEN 1 ELSE 0 END) AS Construction_or_plumbing, Sum(CASE WHEN complaintype = 'Noise - Commercial' THEN 1 ELSE 0 END) AS Noise_commercial, Sum(CASE WHEN complaintype = 'Noise - Vehicle' THEN 1 ELSE 0 END) AS Noise_vehicle, Sum(CASE WHEN complaintype = 'Damaged Tree' THEN 1 ELSE 0 END) AS damaged_tree, Sum(CASE WHEN complaintype = 'Sidewalk Condition' THEN 1 ELSE 0 END) AS sidewalk_condition, Sum(CASE WHEN complaintype = 'Rodent' THEN 1 ELSE 0 END) AS Rodent, Sum(CASE WHEN complaintype = 'Sewer' THEN 1 ELSE 0 END) AS Sewer, Sum(CASE WHEN complaintype = 'Graffiti' THEN 1 ELSE 0 END) AS Graffiti FROM service_calls GROUP BY zipcode;